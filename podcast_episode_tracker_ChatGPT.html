<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Episode Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        th {
            background: #f0f0f0;
        }
        td:hover {
            overflow: visible;
            white-space: normal;
            background: #fafafa;
        }
        .feed-controls {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Podcast Episode Tracker</h1>
    <div class="feed-controls">
        <input type="url" id="rssUrl" placeholder="RSS Feed URL eingeben" style="width: 60%;">
        <button onclick="addFeed()">Feed hinzuf√ºgen</button>
        <button onclick="exportData()">Daten exportieren (JSON)</button>
        <input type="file" id="importFile" accept=".json" onchange="handleImport(event)" style="display:none;">
        <button onclick="document.getElementById('importFile').click()">Daten importieren</button>
    </div>
    <div id="feedList"></div>
    <table id="episodeTable">
        <thead>
            <tr>
                <th>Podcast</th>
                <th>Episode</th>
                <th>Datum</th>
                <th>Host</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
    let podcastFeeds = [];
    let allEpisodes = [];
    let visibleFeeds = new Set();

    const STORAGE_KEY = 'podcastEpisodeTracker';

    function saveToLocalStorage() {
        const data = { feeds: podcastFeeds, episodes: allEpisodes };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadFromLocalStorage() {
        const dataStr = localStorage.getItem(STORAGE_KEY);
        if (!dataStr) return;
        try {
            const data = JSON.parse(dataStr);
            podcastFeeds = data.feeds || [];
            allEpisodes = data.episodes || [];
            podcastFeeds.forEach(url => visibleFeeds.add(url));
            updateFeedList();
            updateTable();
        } catch (e) {
            console.error('Fehler beim Laden der Daten:', e);
        }
    }

    function exportData() {
        const data = localStorage.getItem(STORAGE_KEY);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'podcast_data.json';
        a.click();
        URL.revokeObjectURL(url);
    }

    function handleImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                podcastFeeds = data.feeds || [];
                allEpisodes = data.episodes || [];
                podcastFeeds.forEach(url => visibleFeeds.add(url));
                saveToLocalStorage();
                updateFeedList();
                updateTable();
            } catch (err) {
                alert('Fehler beim Importieren der Datei: ' + err.message);
            }
        };
        reader.readAsText(file);
    }

    async function addFeed() {
        const url = document.getElementById('rssUrl').value.trim();
        if (!url || podcastFeeds.includes(url)) return;
        podcastFeeds.push(url);
        visibleFeeds.add(url);
        await fetchFeed(url);
        saveToLocalStorage();
        updateFeedList();
        updateTable();
        document.getElementById('rssUrl').value = '';
    }

    async function fetchFeed(url) {
        try {
            const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
            const text = await response.text();
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, 'text/xml');
            const podcastTitle = xml.querySelector('channel > title')?.textContent || 'Unbekannter Podcast';
            xml.querySelectorAll('item').forEach(item => {
                const title = item.querySelector('title')?.textContent || 'Unbekannter Titel';
                const date = item.querySelector('pubDate')?.textContent || '';
                const host = item.querySelector('itunes\\:author')?.textContent || 'Unbekannt';
                allEpisodes.push({ podcastTitle, title, date, host, feedUrl: url });
            });
        } catch (e) {
            console.error('Fehler beim Abrufen des Feeds:', e);
        }
    }

    function updateFeedList() {
        const list = document.getElementById('feedList');
        list.innerHTML = podcastFeeds.map(url => `
            <div>
                <strong>${url}</strong>
                <button onclick="toggleFeed('${url}')">
                    ${visibleFeeds.has(url) ? 'Verbergen' : 'Anzeigen'}
                </button>
            </div>
        `).join('');
    }

    function toggleFeed(url) {
        if (visibleFeeds.has(url)) {
            visibleFeeds.delete(url);
        } else {
            visibleFeeds.add(url);
        }
        updateFeedList();
        updateTable();
    }

    function updateTable() {
        const tbody = document.querySelector('#episodeTable tbody');
        const episodes = allEpisodes.filter(ep => visibleFeeds.has(ep.feedUrl));
        tbody.innerHTML = episodes.map(ep => `
            <tr>
                <td title="${ep.podcastTitle}">${ep.podcastTitle}</td>
                <td title="${ep.title}">${ep.title}</td>
                <td>${ep.date}</td>
                <td title="${ep.host}">${ep.host}</td>
            </tr>
        `).join('');
    }

    loadFromLocalStorage();
    </script>
</body>
</html>
